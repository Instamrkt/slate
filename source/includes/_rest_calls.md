# REST Calls

<aside class="notice">
Every REST call requires a server generated xsrf token. This (encrypted) token is generated by the server and saved on the client as soon as the user hits the first site / screen.
</aside>

<aside class="notice">
All requests that require personal information require a userId parameter which is checked against a secure cookie.
</aside>

<aside class="notice">
All responses are of type `application/json`.
</aside>

<aside class="notice">
All POST requests should include a body that is a valid JSON-formatted string.
You can test all POST methods on the command line (from a terminal) using CURL as follows:


```
curl -H "Content-Type: application/json" -X POST  -d '{"JSONMessage": "body"}' https://dev.instamrkt.com/i/r/RESTEndpoint
```
</aside>


Response outcomes and sent response codes:

Response | Code
--------- | -------
SUCCESS | 200
UNAUTHORIZED | 401
AUTH_REQUIRED | 403
ERROR | 500

## Login

> Sample request object:

```javascript
var $       = require('jquery');
var jqxhr = $.ajax('/r/login', {
            type: 'POST',
            headers: {
                'X-XSRFToken': _xsrf
            },
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify({
                'username': loginname,
                'password': password,
                'invite_id': url_utils.getUrlParam('challengeId')
            })
        });
```

This is used to sign a user in.

### URL
`/r/login/`

### Request type

`POST`

### Request Parameters

Parameter | Description
--------- | -------
username | Login of the user attempting to sign in.
password | Password of the user attempting to sign in.
next | The page where user is supposed to be redirected after login. Will be appended to the generated redirect url. Optional.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
username | null | Username of the signed in user (= passed loginname). Sent only on **successful** request.
id | null | Id of the signed in user. Necessary for Websocket API connection. Sent only on **successful** request.
user_session_key | null | Session key for connecting to websocket. Necessary for Websocket API connection. Sent only on **successful** request.
redirect_url | /i/play | Redirect url for a signedin user (presumably for an endpoint requiring authentication). Can be used only on **successful** request.
msg | null | Error message. Sent only on **unsuccessful** request.

## Oauthlogin - DO NOT USE

> Sample request object:

```javascript
var $       = require('jquery');
$.post('/r/login/oauth/', {
  'oauthId': oauth_id,
  'oauthToken': oauthToken,
  'oauthEmail': oauthEmail,
  'oauthProvider': oauthProvider
});
```

This is used to sign a user in.

### URL
`/r/login/oauth/`

### Request type

`POST`

### Request Parameters

Parameter | Description
--------- | -------
oauthId | Oauth id.
oauthToken | Oauth token.
oauthEmail | Oauth email (which the user will be registered with).
oauthProvider | Oauth provider (facebook, google etc.).
next | The page where user is supposed to be redirected after login. Will be appended to the generated redirect url. Optional.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
username | null | Username of the signed in user. Sent only on **successful** request.
id | null | Id of the signed in user. Necessary for Websocket API connection. Sent only on **successful** request.
redirect_url | /i/play | Redirect url for a signedin user (presumably for an endpoint requiring authentication). Can be used only on **successful** request.
msg | null | Error message. Sent only on **unsuccessful** request.


## Logout

> Sample request object:

```javascript
var $       = require('jquery');
var jqxhr = $.ajax('/r/logout', {
            type: 'POST',
            headers: {
                'X-XSRFToken': _xsrf
            },
            contentType: 'application/json; charset=utf-8'
        });
```

This is used to sign a user out. User id is inferred from the secure cookie.

### URL
`/r/logout/`

### Request type

`POST`

### Request Parameters

Parameter | Description
--------- | -------
- | -

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
- | - | The user has been signed out.


## Signup

> Sample request object:

```javascript
var $ = require('jquery');
var jqxhr = $.ajax('/r/signup', {
           type: 'POST',
           contentType: 'application/json; charset=utf-8',
           dataType: 'json',
           data: JSON.stringify({
               'username': username,
               'email': email,
               'password': password,
               'invite_id': url_utils.getUrlParam('challengeId')
           })
       });
});
```

This is used to sign a user in.

### URL
`/r/signup/`

### Request type

`POST`

### Request Parameters

Parameter | Description
--------- | -------
username | Selected username to be validated an assigned in case of successful signup.
password | Selected password of the user attempting to sign up.
email | The email used to sign up (validated against our database, must be unique). All external communication will be directed to this email.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
username | null | Username of the signed up user. Sent only on **successful** request.
user_id | null | Id of the signed up user. Necessary for Websocket API connection. Sent only on **successful** request.
redirect_url | /i/play | Redirect url for a signedin user (presumably for an endpoint requiring authentication). Can be used only on **successful** request.
msg | null | Error message. Sent only on **unsuccessful** request.


## Games - history of games played for user

> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/games/history/[USER_ID]', {
  headers: {
      'X-XSRFToken': _xsrf
  },
})
```

This is used to request a user's game history (all the games he has predicted in).

### URL
`/r/games/history/[USER_ID]`

### Request type

`GET`

### Request Parameters

Parameter | Description
--------- | -------
userId | Id of the user whose game history is to be retrieved.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
game_history | [] | A list of objects representing games. Each object contains the following fields: id, name, type, open_at, close_at.


## Games - list active games for source

> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/sources/c294ecdc-9194-428a-8353-20513856cda1/games/active/', {
  headers: {
      'X-XSRFToken': _xsrf
  }
})
```

This is used to request active games for a specific source.

### URL
`/r/sources/SOURCE_UUID/games/active/`

### Request type

`GET`

### Request Parameters

Parameter | Description
--------- | -------
- | -

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
games_active | [] | A list of objects representing games. Each object contains the following fields: game_id, opening_source_id (for the source hosting the game), name, teams, type, status, open_at, close_at, live_start_at.

## Games - list upcoming games for source

> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/sources/c294ecdc-9194-428a-8353-20513856cda1/games/upcoming/', {
  headers: {
      'X-XSRFToken': _xsrf
  }
})
```

This is used to request upcoming games for a specific source.

### URL
`/r/sources/SOURCE_UUID/games/upcoming/`

### Request type

`GET`

### Request Parameters

Parameter | Description
--------- | -------
- | -

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
upcoming_games | [] | A list of objects representing games. Each object contains the following fields: id, source_id (for the source hosting the game), game_name, currency, live_start_at, game_type_id, hashtag.


## Games - get active open pools for game

Get prediction pools for a specified active game. Requesting user id is retrieved from a url. This id is used to determine whether a pool is open or running (and whether should be included). For a user who is not logged in (no user id specified) all pools are sent as open.

### URL
`/r/sources/SOURCE_UUID/games/active/<game_uuid>/pools/open/<user_id>`

### Request type

`GET`

### Request Parameters

Parameter | Default | Description
--------- | ------- | -----------
game_uuid | null | The uuid of the game for which you are requesting pools. This can be obtained from the `/r/games/active` list of games.
user_id | null | Optional: specify user id to send only open pools (exclude the ones user predicted in).

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
pools | [] | Array of objects. An array of open pool objects for the specified game.

Each pool object includes the following fields:

Field | Default | Description
--------- | ------- | -----------
start_at | n/a | opening time of the pool in epoch milliseconds UTC
description | null | textual title of the pool
amount_total | 0.0 | total value of points in the pool - not for a specific target
finish_at | null | closing time of the pool in epoch milliseconds UTC
distribution | [] | array of distribution objects for each target in the pool including user_id[] of predictors, the current multiplier, the target_id, display_name and total amount for each target
target_level | 1 | the level of the target that is the subject of the prediction (usually 1 unless this is a subtarget)
participants | 0 | total number of players in the pool
pool_id | n/a | the uuid of this pool
stop_accepting_bets_at | null | time in epoch milliseconds UTC when to stop accepting incoming predictions
type | n/a | The type of pool - a combination of parimutuel or binary and event based or time based
action_id | n/a | the uuid of the action which this pool relates to
game_id | GAME_UUID | the game for which the pool is active
is_blocked | null | Indicates if the pool is currently blocked.
is_hot | null | Indicates if the pool is currently hot.


## Games - get upcoming open pools for game

Get prediction pools for a specified upcoming game. Requesting user id is retrieved from a url. This id is used to determine whether a pool is open or running (and whether should be included). For a user who is not logged in (no user id specified) all pools are sent as open.

### URL
`/r/sources/SOURCE_UUID/games/upcoming/<game_uuid>/pools/open/<user_id>`

### Request type

`GET`

### Request Parameters

Parameter | Default | Description
--------- | ------- | -----------
game_uuid | null | The uuid of the game for which you are requesting pools. This can be obtained from the `/r/games/upcoming` list of games.
user_id | null | Optional: specify user id to send only open pools (exclude the ones user predicted in).

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
pools | [] | Array of objects. An array of open pool objects for the specified game.

Each pool object includes the following fields:

Field | Default | Description
--------- | ------- | -----------
start_at | n/a | opening time of the pool in epoch milliseconds UTC
description | null | textual title of the pool
money_at_stake | 0.0 | total value of points in the pool - not for a specific target
finish_at | null | closing time of the pool in epoch milliseconds UTC
distribution | [] | array of distribution objects for each target in the pool including user_id[] of predictors, the current multiplier, the target_id, display_name and total amount for each target
target_level | 1 | the level of the target that is the subject of the prediction (usually 1 unless this is a subtarget)
people_involved | 0 | total number of players in the pool
pool_id | n/a | the uuid of this pool
stop_accepting_bets_at | null | time in epoch milliseconds UTC when to stop accepting incoming predictions
type | n/a | The type of pool - a combination of parimutuel or binary and event based or time based
action_id | n/a | the uuid of the action which this pool relates to

## Games - get upcoming running pools for game

Get prediction pools for a specified upcoming game. Requesting user id is retrieved from a url. This id is used to determine whether a pool is open or running (and whether should be included). For a user who is not logged in (no user id specified) no pools are sent as running.

### URL
`/r/sources/SOURCE_UUID/games/upcoming/<game_uuid>/pools/running/<user_id>`

### Request type

`GET`

### Request Parameters

Parameter | Default | Description
--------- | ------- | -----------
game_uuid | null | The uuid of the game for which you are requesting pools. This can be obtained from the `/r/games/upcoming` list of games.
user_id | null | Optional: specify user id to send only running pools.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
pools | [] | Array of objects. An array of running pool objects for the specified game.

Each pool object includes the following fields:

Field | Default | Description
--------- | ------- | -----------
start_at | n/a | opening time of the pool in epoch milliseconds UTC
description | null | textual title of the pool
money_at_stake | 0.0 | total value of points in the pool - not for a specific target
finish_at | null | closing time of the pool in epoch milliseconds UTC
distribution | [] | array of distribution objects for each target in the pool including user_id[] of predictors, the current multiplier, the target_id, display_name and total amount for each target
target_level | 1 | the level of the target that is the subject of the prediction (usually 1 unless this is a subtarget)
people_involved | 0 | total number of players in the pool
pool_id | n/a | the uuid of this pool
stop_accepting_bets_at | null | time in epoch milliseconds UTC when to stop accepting incoming predictions
type | n/a | The type of pool - a combination of parimutuel or binary and event based or time based
action_id | n/a | the uuid of the action which this pool relates to


## Active Games - make predictions

Enter predictions into a specified pool.

### URL
`/r/sources/SOURCE_UUID/games/active/<game_uuid>/pools/open/<pool_uuid>/predictions/`

### Request type

`PUT`, `POST`

### Request Parameters In URL

Parameter | Default | Description
--------- | ------- | -----------
source_uuid | null | The uuid of the source for which the game is active.
game_uuid | null | The uuid of the game for which you are entering predictions. This can be obtained from the `/r/games/active` list of games.
pool_uuid | null | The uuid of the pool for which the prediction should be entered.

An example query string is: `/i/r/games/active/ad5db7bf-cd91-4d5d-a635-cf335661d69d/pools/open/ab571569-08b2-4a88-9d9e-47145370e67f/predictions/`

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
status | 200 | Response code of the request
msg | [] | Empty if status = 200
bet_obj | "" | Standardized prediction object including the `bet_id`, `amount`, `by_friend` (was it made by a friend), `game_id`, `placed_at`, `target_id`, `user_id` (user who made a prediction), `username` (user who made a prediction).

Note that each pool is serialized individually. One pool per request. For example, to make 3 predictions you must send 3 requests.

### Payload
Parameter | Default | Description
--------- | ------- | -----------
target_id | null | The id of the selected target for which prediction is entered.
amount | null | The amount for which the prediction is placed.


## Upcoming Games - make pregame predictions

Enter pre-game predictions into a specified pool.

### URL
`/r/sources/SOURCE_UUID/games/upcoming/<game_uuid>/pools/<pool_uuid>/predictions/`

### Request type

`PUT`, `POST`

### Request Parameters In URL

Parameter | Default | Description
--------- | ------- | -----------
source_uuid | null | The uuid of the source for which the game is upcoming.
game_uuid | null | The uuid of the game for which you are entering predictions. This can be obtained from the `/r/games/upcoming` list of games.
pool_uuid | null | The uuid of the pool for which the prediction should be entered.
email | null | Since we only have an email address at this point we create an account for this user and assign a random password which can be recovered.


NOTE: email MUST be appended the query string and not in the payload.

An example query string is: `/i/r/games/upcoming/ad5db7bf-cd91-4d5d-a635-cf335661d69d/pools/ab571569-08b2-4a88-9d9e-47145370e67f/predictions/?email=timir@instamrkt.com`

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
status | 200 | Response code of the request
msg | [] | Empty if status = 200
username | "" | The assigned username.
user_id | "" | The user id of the user's account (possibly newly created).
user_session_key | null | The session key of the user (included only for newly created accounts, otherwise null).
needs_auth | "" | Indication whether user needs to authenticate to join the full game.

Note that each pool is serialized individually. One pool per request. For example, to make 3 predictions you must send 3 requests.

### Payload
Parameter | Default | Description
--------- | ------- | -----------
user_backed | null | An object with a single key and value. The key is the target_id of the users prediction and the value is the amount to place on this target.


## Statistics
This is used to request user's personal statistics.

> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/statistics/[USER_ID]', {
  headers: {
      'X-XSRFToken': _xsrf
  }
})
```

### URL
`/r/statistics/[USER_ID]`

### Request type

`GET`

### Request Parameters

Parameter | Description
--------- | -------
userId | Id of the user whose statistics are to be retrieved.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
statistics | {} | A dictionary containing selected user's personal statistics. **key** - statistic name, **value** - statistic value. Sent statistics: total_bets_won, total_bets_lost, average_number_of_bets_per_game, average_points_won_per_game, average_reaction_time.

## Friends

> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/friends/[USER_ID]', {
  headers: {
      'X-XSRFToken': _xsrf
  },
})
```

This is used to request user's personal statistics.

### URL
`/r/friends/`

### Request type

`GET`

### Request Parameters

Parameter | Description
--------- | -------
userId | Id of the user whose friends are to be retrieved.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
friends | {} | A dictionary containing selected user's personal statistics. **key** - friend's user id, **value** - friend's name.


## Leaderboard global


> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/leaderboard/global/', {
  headers: {
      'X-XSRFToken': _xsrf
  }
})
```

This is used to request a global leaderboard. If `USER_ID` is included, the leaderboard can be personalised according to the parameters described below.

This does not send the full leaderboard - only top, bottom and requestor's surroundings.

### URL
`/r/leaderboard/global/[USER_ID]`

### Request type

`GET`

### Request Parameters

Parameter | Default | Description
--------- | ------- | -------
top_count | 3 | | How many users to show on the top of the leaderboard.
bottom_count | 3 | How many users to show on the bottom of the leaderboard.
surrounding_count 1 | How many users directly above and below requesting user.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
leaderboard | [] | A list of objects. Every object contains `username`, `rank` and `points`.
break_after_rank | [] | A list of ranks after which leaderboard loses its continuity. For a leaderbord with ranks: [1,2,3,17,18,98,99,100] this array would be equal to [3,18]. It indicates where to display breaks in leaderboard.

## Leaderboard global per game

Global game leaderboard can be requested in the exact same manner as <a href="#leaderboard-global">a global leaderboard</a>. The only difference is the url, shown below.

### URL
`/r/leaderboard/global/game/[GAME_UUID]/[USER_ID]`

## Leaderboard global per game source

Global game source leaderboard can be requested in the exact same manner as <a href="#leaderboard-global">a global leaderboard</a>. The only difference is the url, shown below.

### URL
`/r/leaderboard/global/source/[SOURCE_UUID]/[USER_ID]`


## Leaderboard personal

> Sample request object:

```javascript
var $       = require('jquery');
var cookies = require('cookie-getter');
var _xsrf   = cookies('_xsrf')

$.get('/r/leaderboard/personal/[USER_ID]', {
  headers: {
      'X-XSRFToken': _xsrf
  }
})
```

This is used to request a personal leaderboard. The returned leaderboard is full, contains each user ranked below `start` and `end`.

### URL
`/r/leaderboard/personal/[USER_ID]`

### Request type

`GET`

### Request Parameters

Parameter | Default | Description
--------- | ------- | -------
start | 1 | | Start leaderboard at rank.
end | 10000000 | End leaderboard at rank.

### Response Parameters

Parameter | Default | Description
--------- | ------- | -----------
leaderboard | [] | A list of objects. Every object contains `username`, `rank` and `points`.

## Leaderboard personal per game

Personal game leaderboard can be requested in the exact same manner as <a href="#leaderboard-personal">a personal leaderboard</a>. The only difference is the url, shown below.

### URL
`/r/leaderboard/personal/game/[GAME_UUID]/[USER_ID]`

## Leaderboard personal per game source

Personal game source leaderboard can be requested in the exact same manner as <a href="#leaderboard-personal">a personal leaderboard</a>. The only difference is the url, shown below.

### URL
`/r/leaderboard/personal/source/[SOURCE_UUID]/[USER_ID]`